name: Typeset CSTUG Bulletin
on:
- push
permissions:
  contents: write
env:
  DEBIAN_FRONTEND: noninteractive
jobs:
  build:
    name: Typeset CSTUG Bulletin
    runs-on: ubuntu-latest
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v6
        with:
          submodules: recursive
      - name: Install requirements
        run: |
          set -e
          sudo apt update
          sudo apt install -y ghostscript libxml2-utils moreutils optipng parallel poppler-utils python3-pdfminer jpegoptim imagemagick
#     - name: Validate metadata
#       run: make test-xml
      - name: Build Docker images
        run: make images
      - name: Typeset CSTUG Bulletin
        run: make all
      - name: Upload PDF documents as build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: Extracted citations
          path: |
            */extract-citations_result.xml
      - name: Upload extracted citations as build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: PDF
          path: |
            bul.pdf
            bul-web.pdf
            bul-obalka-margins-*mm.pdf
            bul-blok-margins-*mm.pdf
      - name: Validate PDF documents
        run: make test
      - name: Upload PDF documents as a release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          name: The latest version
          tag_name: latest
          prerelease: true
          token: ${{ secrets.GITHUB_TOKEN }}
          files: |
            bul.pdf
            bul-web.pdf
            bul-obalka-margins-*mm.pdf
            bul-blok-margins-*mm.pdf
